<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book Info</title>
    <link href="../static/css/styles.css" rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
<div class="container">
    <h1>Book</h1>

    <div class="navigation">
        <a class="btn btn-secondary" href="allBooksPage.html" th:href="@{/}">Main Page</a>
    </div>


    <div class="book-info">
        <h1 id="book-title">Book Title</h1>

        <div class="book-info">
            <div class="info-row">
                <span class="info-label">ID:</span>
                <span class="info-value" id="book-id">123</span>
            </div>

            <div class="info-row">
                <span class="info-label">Author:</span>
                <span class="info-value" id="book-author">Author Name</span>
            </div>

            <div class="info-row">
                <span class="info-label">Genres:</span>
                <span class="info-value" id="book-genres">Genres</span>
            </div>

            <div class="comments-container">
                <span class="info-label">Commentaries:</span>
                <div class="comment-list" id="comment-list">
                    <div>Comment</div>
                </div>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <a class="btn btn-edit" id="add-comment-btn">Add Comment</a>
        <a class="btn btn-edit" id="edit-book-btn">Edit Book</a>
        <button class="btn btn-delete" id="delete-book-btn">Delete Book</button>
    </div>

</div>

<script>
    // Получаем ID книги из URL
    const bookId = new URLSearchParams(window.location.search).get('id');

    // Вызываем функцию при загрузке страницы
    document.addEventListener('DOMContentLoaded', fillPage);

    //Настраиваем кнопки
    document.getElementById('add-comment-btn').href = `/comment/add_to_book/${bookId}`;
    document.getElementById('edit-book-btn').href = `/book/${bookId}/edit`;
    // Функция удаления книги
    document.getElementById('delete-book-btn').addEventListener('click', async function () {
        if (!confirm('Delete this book?')) return;

        try {
            const response = await fetch(`/api/v1/books/${bookId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                window.location.href = '/';
            } else {
                alert('Failed to delete book');
            }
        } catch (error) {
            console.error('Error deleting book:', error);
            alert('Oops! Something went wrong.');
        }
    });

    async function fillPage() {
        //Собираем инфу по книге
        await getBook();
        //Подтягиваем комментарии
        await getComments();
    }

    async function getBook() {
        try {
            // 1. Делаем запрос и ждем ответа
            const response = await fetch(`/api/v1/books/${bookId}`);

            // 2. Проверяем статус ответа
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // 3. Преобразуем ответ в JSON
            const book = await response.json();

            // 4. Обновляем DOM
            document.getElementById("book-title").textContent = book.title;
            document.getElementById("book-id").textContent = book.id;
            document.getElementById("book-author").textContent = book.author.fullName;

            //Жанры
            const genresList = document.getElementById("book-genres");
            genresList.innerHTML = '';//почистим дефолтное значение
            book.genres.forEach((genre, index) => {
                const genreSpan = document.createElement('span');
                genreSpan.className = 'genre-tag';
                genreSpan.textContent = genre.name;
                genresList.appendChild(genreSpan);

                if (index !== book.genres.length - 1) {
                    const commaSpan = document.createElement('span');
                    commaSpan.textContent = ', ';
                    genresList.appendChild(commaSpan);
                }
            });
        } catch (error) {
            console.error('Error loading book data:', error);
            alert('Oops! Something went wrong.');
        }

    }

    async function getComments() {
        try {

            // Загрузка комментариев
            const commentsResponse = await fetch(`/api/v1/books/${bookId}/comments`);
            if (!commentsResponse.ok) throw new Error('Failed to load comments');
            const comments = await commentsResponse.json();

            // Отображаем комментарии
            const commentList = document.getElementById('comment-list');
            commentList.innerHTML = '';

            if (comments.length === 0) {
                commentList.innerHTML = '<div>No comments yet</div>';
            } else {
                comments.forEach(comment => {
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'comment-line';

                    commentDiv.innerHTML = `
                        <div class="comment-content">
                            <span>${comment.id}:</span>
                            <span>${comment.text}</span>
                        </div>
                        <div class="comment-actions">
                            <a class="btn btn-edit" href="/comment/edit/${comment.id}">Edit</a>
                            <button class="btn btn-delete" onclick="deleteComment(${comment.id}, ${bookId})">Delete</button>
                        </div>
                    `;
                    commentList.appendChild(commentDiv);
                });
            }
        } catch (error) {
            console.error('Error loading comments:', error);
            document.getElementById('comment-list').textContent = 'Error loading comments';
        }
    }

    // Функция удаления комментария
    async function deleteComment(commentId, bookId) {
        if (!confirm('Delete this comment?')) return;

        try {
            const response = await fetch(`/api/v1/comments/${commentId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                // Перезагружаем данные
                await fillPage();
            } else {
                alert('Oops! Something went wrong.');
            }
        } catch (error) {
            console.error('Error deleting comment:', error);
            alert('Oops! Something went wrong.');
        }
    }
</script>
</body>
</html>